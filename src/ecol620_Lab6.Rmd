---
title: "Lab 6 - Connectivity"
subtitle: "ECOL 620 - Applications in Landscape Ecology"
author: "George Woolsey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    # code_folding: hide
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding){ 
    out_dir <- '../';
    rmarkdown::render(inputFile, encoding = encoding, output_file=file.path(dirname(inputFile), out_dir, 'index.html'));
    file.copy(from = "..//index.html", to = '..///data//lab6_george_woolsey.html', overwrite = TRUE)
  })
---

# Setup

```{r, include=FALSE, warning=F, message=F}
# knit options
knitr::opts_chunk$set(
  echo = TRUE
  , warning = FALSE
  , message = FALSE
  # , results='hide'
  , fig.width = 10
  , fig.height = 7
)
```

```{r}
# bread-and-butter
library(tidyverse)
library(lubridate)
library(viridis)
library(scales)
library(latex2exp)
# visualization
library(kableExtra)
library(cowplot)
# spatial analysis
library(terra)
library(stars)
library(gdistance) #for least-cost paths/circuit theory; version 1.2-2 used
library(igraph) #for patch-based graphs; version 1.2.2 used
# set seed
set.seed(11)
```

# Rules

Complete your assignment using the R markdown file and submit individual assignments to Canvas. Knit your script and submit an .html file on Canvas. Please use  the following naming convention: lab6_firstname_lastname.html (ex. lab6_kyle_horton.html).  Note, we will not grade labs in any other format.

---

# Effective distances:

## Question 1

Describe the primary differences using Euclidean distance, least-cost distance, circuit theory (commute distance), and randomized shortest-path distance to measure effective distance. Which do you feel yields the most robust estimation? (4-5 sentences) (5 pts) 

<span style="color: teal;">
Effective distance is used to quantify landscape connectivity as a measure for distance "modified with the cost to move between habitat patches based on detailed geographical information on the landscape as well as behavioural aspects of the organisms studied" ([Adriaensen et al. 2003](https://www.sciencedirect.com/science/article/abs/pii/S0169204602002426), p.233). Euclidean distance, least-cost distance, circuit theory (commute distance), and randomized shortest-path distance are four commonly used metrics to measure effective distance. Euclidean distance measures aerial distance and ignores the cost to move between habitat patches. Least-cost distance measures the shortest distance between habitat patches based on the path that includes the minimum cumulative costs to move. Circuit theory (commute distance) calculates distance by quantifying the expected time for an individual to move from one location to another and back again. Randomized shortest-path distance links the idea of least-cost paths and resistance distances as being along a continuum of movement possibilities by altering a parameter, $\theta$ (when $\theta=0$, the model is equivalent to a circuit theory approach; as $\theta$ increases the model approaches the least-cost distance method). The most appropriate measure of effective distance should be selected based on the study objectives, the species dispersal mechanism, and prior knowledge ([Diniz et al. 2020](https://link.springer.com/article/10.1007/s10980-019-00935-3)).
</span>

## Question 2	

### Load data

```{r, results='hide'}
# landcover data for florida panther
landcov <- terra::rast("../data/panther_landcover.tif")
# check it
transform_crs <- terra::crs(landcov)
terra::res(landcov)
terra::ext(landcov)
if(FALSE){
  paste0((terra::expanse(landcov) / 10000) %>% scales::comma(), " ha")
  plot(landcov)
}
# load public areas in need of connections
public_lands <- sf::st_read("../data/panther_publicland.shp") %>% 
  dplyr::rename_with(tolower)
# set crs
sf::st_crs(public_lands) <- transform_crs
# check it
public_lands %>% sf::st_set_geometry(NULL) %>% dplyr::glimpse()
if(FALSE){
  ggplot(public_lands) + 
    geom_sf(aes(fill=maname_ab)) + 
    scale_fill_viridis_d() + 
    theme_bw()
}
```


### part a	

How many landcover classes are represented in the "panther_landcover" raster? (1 pt)

```{r, eval=FALSE}
landcov %>% terra::unique() %>% nrow()
```

<span style="color: teal;">
The "panther_landcover.tif" raster data includes **`r landcov %>% terra::unique() %>% nrow()`** unique values.
</span>

### part b

How many classes remain after the reclassification to resistance, i.e., "land_cost"? (1 pt)

A resistance surface values raster cells to indicate the resistance or difficulty imposed by environmental components on movement of individuals.

```{r, results='hide'}
# load reclassification to resistance surface
resistance_reclass <- read.table("../data/resistance reclass.txt", header = T) %>% 
  dplyr::rename_with(tolower)
resistance_reclass %>% dplyr::glimpse()
# create resistance surface raster
rcl_matrix <- resistance_reclass %>% dplyr::select(landcover, changeto) %>% as.matrix()
resistance_surface <- terra::classify(landcov, rcl = rcl_matrix)
resistance_surface %>% terra::unique() %>% nrow()
if(FALSE){
  plot(resistance_surface)
}
```

<span style="color: teal;">
After reclassification, the resistance surface raster includes **`r resistance_surface %>% terra::unique() %>% nrow()`** unique values.
</span>

### part c

From the supplied rankings, which landcover classes (from the original classification)  provide the most and least resistance to the movement of Florida panthers? (1 pt) 

```{r}
tbl_temp <- terra::freq(resistance_surface) %>% 
  as.data.frame() %>% 
  dplyr::rename(resistance=value) %>% 
  dplyr::left_join(
    resistance_reclass %>% dplyr::select(-landcover)
    , by = c("resistance" = "changeto")
  ) %>% 
  dplyr::arrange(resistance) %>% 
  dplyr::mutate(
    lbl = paste0("Resistance ", resistance, " (pixels=", scales::comma(count), ")")
  )
# table
kableExtra::kable(
    tbl_temp %>% dplyr::select(description)
    , caption = "Resistance Surface for Florida panthers<br>*lowest to highest resistance"
    , col.names = c("")
  ) %>% 
  kable_classic("striped", full_width=T) %>%
  pack_rows(index = table(forcats::fct_inorder(tbl_temp$lbl)))
```

<span style="color: teal;">
The table above provides details of the landcover classes (from the original classification) grouped by resistance to the movement of Florida panthers.
</span>

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
gc()
```

### part d

How are the resistance measures determined? (1-2 sentences) (1 pt)

## Question 3	

After calculating effective distance with the four methods (Euclidean distance, least-cost distance, commute distance, and randomized shortest-paths distance), which are most and least correlated? (4 pts)

```{r}

```


## Question 4	

Within plot 9.7 of Fletcher and Fortin, what does a single point mean? Why are there 10 points per plot? (1-2 sentences) (2 pts)


## Question 5

a)	Using the four methods (Euclidean distance, least-cost distance, commute distance, and randomized shortest-paths distance), make a single four-paneled plot with line segments connecting the public land centroids with the cost raster and protected areas under these segments. Weight the line segments by the inverse of the effective distance. Use ggplot to generate the plot. See example on Canvas (11 pts)
```{r}

```


### part b

Do you see any prominent differences among the methods? You can make a visual assessment. (1-2 sentences) (2 pts)


### part c

Which conservation area pairing shows the greatest travel cost by least cost distance? Which conservation area pairing shows the least travel cost by circuit theory? Please provide the names of the parks. (2 pts)

---

# Least-cost path & Least-cost corridor

## Question 6

Plot the least cost-path and least-cost corridor between Okaloacoochee Slough State Forest and Fred C. Babcock-Cecil M. Webb Wildlife Management Area using the lower 20% of accumulated cost cells. Include the outline of the conservation areas, the centroid points (of the conservation areas), and the resistance surface. Use ggplot to generate the plot. (8 pts)

```{r}

```

### part a)	

What is the dominant cover type in the corridor? (3.5 pts)

```{r}

```


### part b

Whatâ€™s the Shannon diversity and evenness in the corridor? (3.5 pts)

```{r}

```

---

# Flow mapping

## Question 7

Generate a four-panel plot (analogous to figure 9.10) using theta values of 0.000, 0.000001, 0.00001, and 0.001, but mapping probabilities between Okaloacoochee Slough State Forest and Fred C. Babcock-Cecil M. Webb Wildlife Management Area. What do the theta values signify? How do they influence connectivity measures? Use ggplot. (5 pts)

```{r}

```


